name: Generate Test Report

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Configurar el repositorio
      - name: Checkout code
        uses: actions/checkout@v3

      # Verificar estructura de carpetas para depuraci칩n
      - name: List directories
        run: |
          ls -R

      # Instalar PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      # Instalar PowerShell (si no est치 disponible)
      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https software-properties-common
          wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      # Instalar dependencias de Playwright
      - name: Install Playwright dependencies
        run: |
          dotnet build project/tests/UI/AppTest.csproj
          pwsh ./project/tests/UI/bin/Debug/net8.0/playwright.ps1 install

      # Limpiar videos anteriores (si existen)
      - name: Clean old videos
        run: rm -rf project/tests/UI/videos

      # Iniciar el servidor PHP
      - name: Start PHP Server
        run: |
          # Iniciar el servidor PHP en segundo plano
          php -S localhost:8000 -t project/public &
          # Esperar unos segundos para asegurarse de que el servidor est치 listo
          sleep 30

      # Verificar si el servidor PHP est치 funcionando
      - name: Check if PHP server is running
        run: |
          curl --silent --fail http://localhost:8000 || exit 1

      # Ejecutar las pruebas
      - name: Run Playwright tests
        run: |
          dotnet build project/tests/UI/AppTest.csproj
          dotnet test project/tests/UI/AppTest.csproj --collect:"XPlat Code Coverage"

      # Subir videos como artefactos
      - name: Upload Test Videos
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-videos
          path: project/tests/UI/videos/

      # Generar reporte de cobertura
      - name: Generate Coverage Report
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          export PATH="$PATH:~/.dotnet/tools"
          reportgenerator -reports:"**/coverage.cobertura.xml" -targetdir:"coverage-report" -reporttypes:HTML

      # Publicar artefactos (Reporte HTML)
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage-report/
