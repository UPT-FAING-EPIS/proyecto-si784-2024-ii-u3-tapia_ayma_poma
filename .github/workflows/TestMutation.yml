name: Mutation Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  mutation-tests:
    runs-on: ubuntu-latest

    steps:
    # Clona el código del repositorio
    - name: Checkout code
      uses: actions/checkout@v3

    # Configura PHP
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: xdebug # Necesario para la cobertura de código

    # Instala las dependencias de Composer
    - name: Install dependencies
      run: |
        cd project
        composer install

    # Corrige permisos para el directorio de informes
    - name: Fix permissions for mutation report directory
      run: |
        chmod -R 777 project/informes/mutacion

    # Genera la cobertura de código en formato XML
    - name: Generate PHPUnit coverage (XML)
      run: |
        cd project
        php vendor/bin/phpunit --coverage-xml=coverage

    # Genera el archivo infection-log.txt
    - name: Generate infection log
      run: |
        cd project
        php vendor/bin/infection --coverage=coverage \
          --log-file=informes/mutacion/infection-log.txt

    # Genera el archivo infection-summary.txt
    - name: Generate infection summary
      run: |
        cd project
        php vendor/bin/infection --coverage=coverage \
          --summary-log=informes/mutacion/infection-summary.txt

    # Genera el archivo infection-report.html
    - name: Generate infection HTML report
      run: |
        cd project
        php vendor/bin/infection --coverage=coverage \
          --html=informes/mutacion/infection-report.html

    # Sube los informes de Infection como artefactos
    - name: Upload mutation test reports as artifacts
      uses: actions/upload-artifact@v3
      with:
        name: infection-mutation-reports
        path: |
          project/informes/mutacion/infection-log.txt
          project/informes/mutacion/infection-summary.txt
          project/informes/mutacion/infection-report.html
